# This config overrides defaults.yml to set the necessary settings for
# enterprise edition.
# You also need to make sure that the following secrets are defined:
# - CACHE_ENDPOINT
# - CACHE_ACCESS_KEY
# - CACHE_SECRET_KEY
# - enterprise_github_token

global:
  # {{ $shop_type := "ee" }}$shop_type: {{ printf "%q" $shop_type }}
  is_enterprise: &is_enterprise true

  git: &git
    # Using the stable branch for the ce shop here, and .Github.RefName refers to
    # the ee shop commit/tag/branch
    shop_ref: &git_shop_ref 'b-8.0.x'
    enterprise_ref: '{{ .Github.RefName }}'

  # only configure/install is different
  composer: &composer
    configure:
      install: ''
    transform: ''


# See docs/actions/prepare_shop.md for more information.
prepare_shop:
  composer:
    transform: |
      {
          "config": {
              "github-protocols": ["https"]
          },
          "require": {
              "oxid-esales/oxideshop-pe": "{{ .Data.global.composer.dev_ref }}",
              "oxid-esales/oxideshop-ee": "dev-{{ .Github.RefName }",
              "oxid-esales/twig-component": "{{ .Data.global.composer.dev_ref }}",
              "oxid-esales/twig-component-pe": "{{ .Data.global.composer.dev_ref }}",
              "oxid-esales/twig-component-ee": "{{ .Data.global.composer.dev_ref }}",
              "oxid-esales/twig-admin-theme": "{{ .Data.global.composer.dev_ref }}",
              "oxid-esales/apex-theme": "{{ .Data.global.composer.dev_ref }}",
              "oxid-esales/codeception-modules": "{{ .Data.global.composer.dev_ref }}",
              "oxid-esales/codeception-page-objects": "{{ .Data.global.composer.dev_ref }}"
          },
          "repositories": {
              "oxid-esales/codeception-page-objects": {
                  "type": "git",
                  "url": "https://github.com/OXID-eSales/codeception-page-objects.git"
              },
              "oxid-esales/codeception-modules": {
                  "type": "git",
                  "url": "https://github.com/OXID-eSales/codeception-modules.git"
              },
              "oxid-esales/twig-component-ee": {
                  "type": "git",
                  "url": "https://github.com/OXID-eSales/twig-component-ee.git"
              },
              "oxid-esales/twig-component-pe": {
                  "type": "git",
                  "url": "https://github.com/OXID-eSales/twig-component-pe.git"
              },
              "oxid-esales/oxideshop-ee": {
                  "type": "git",
                  "url": "https://github.com/OXID-eSales/oxideshop_ee.git"
              },
              "oxid-esales/oxideshop-pe": {
                  "type": "git",
                  "url": "https://github.com/OXID-eSales/oxideshop_pe.git"
              }
          }
      }

  git: *git
  is_enterprise: *is_enterprise
  cache:
    # Needs to be here as $shop_type is different
    prefix: 'preparedShop-{{ $shop_type }}-{{ .Github.SHA }}-{{ .Github.RunNumber }}'

# See docs/actions/start_shop.md and docs/actions/install_shop.md for more information.
install_shop:
  git: *git
  is_enterprise: *is_enterprise
  cache:
    prefix: &install_shop_prefix 'shopInstallation-{{ $shop_type }}-{{ .Github.SHA }}-{{ .Github.RunNumber }}'

install_module:
  cache:
    # Need to set this as we don't install a module. When installing a module:
    # 'moduleInstallation-{{ $shop_type }}-{{ .Github.SHA }}-{{ .Github.RunNumber }}'
    prefix: *install_shop_prefix
  load_shop: *install_shop_prefix

phpunit:
  load_shop: *install_shop_prefix

codeception:
  load_shop: *install_shop_prefix
  container:
    options: '-e SELENIUM_SERVER_HOST=selenium -e BROWSER_NAME=chrome -e THEME_ID=apex'
    method: &selenium_container_method 'run'
  composer: *composer
  configuration: 'vendor/oxid-esales/oxideshop-ee/Tests/codeception.yml'
  additional_options: ''
  output:
    files: |
      docker-compose.yml
      source/composer.json
      source/composer.lock
      source/source/config.inc.php
      source/source/log/oxideshop.log
      data/php/logs/error_log.txt
      source/vendor/oxid-esales/oxideshop-ee/Tests/Codeception/_output
  coverage:
    path: ''

runtest:
  load_shop: *install_shop_prefix
  container:
    options: '-e ACTIVE_THEME=apex'
    method: 'run'
  composer:
    configure:
      install: 'oxideshop_pe oxideshop_ee twig-component-pe twig-component-ee tests-deprecated-pe tests-deprecated-ee'
    require:
      install: |
        tests-deprecated-ce
        codeception/module-webdriver:^3.1
        phpunit/phpunit:^9.1.1
  # yamllint disable-line rule:line-length
  additional_options: '--filter "/^((?!(testFrontendVAT)).)*$/" --exclude-group quarantine,varnish,paypal_buyerlogin,paypal_external,paypal_graphql,adminFunctionality,flow_theme'
  coverage:
    path: ''

sonarcloud:
  matrix:
    testplan: 'skip'

phpcs_tests:
  filter: '^\./source/(Internal|vendor/oxid-esales/oxideshop-[ep]e/Internal)/.*\.php$'
