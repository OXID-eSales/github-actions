name: call-test_matrix
# Full test matrix for oxidshop_ce and oxidshop_ee
# This matrix runs the following jobs:
# - output parameters
# - prepare shop and cache it as preparedShop_<edition>-<ref>-<php_version>-<mysql_version>-<commit_sha>-<run>-<attempt>
# - install shop based on the prepared shop and cache it as shopInstallation_<edition>-<ref>-<php_version>-<mysql_version>-<commit_sha>-<run>-<attempt>
# - run unit tests using the cached shopInstallation
# - run integration tests  using the cached shopInstallation
# - run codeception tests  using the cached shopInstallation
# - run shop setup tests using the cached preparedShop
#
on:
  workflow_call:
    inputs:
      testplan:
        type: string
        description: 'Testplan to run'
        required: true
#      runs_on:
#        type: string
#        description: 'Runner for this workflow'
#        required: false
#        default: '"ubuntu-latest"'
#      git_sdk_url:
#        type: string
#        description: 'URL for the docker-eshop sdk repo to clone'
#        required: false
#        default: 'https://github.com/OXID-eSales/docker-eshop-sdk.git'
#      git_sdk_ref:
#        type: string
#        description: 'Branch, tag or hash of the commit to check out'
#        required: false
#        default: 'master'
#      git_shop_url:
#        type: string
#        description: 'URL for the oxidshop_ce repository'
#        required: false
#        default: 'https://github.com/OXID-eSales/oxideshop_ce.git'
#      git_shop_ref:
#        type: string
#        description: 'Branch, tag or hash of the commit to check out'
#        required: true
#        default: ${{ github.ref_name }}
#      git_enterprise_ref:
#        type: string
#        description: 'Branch to check out for the enterprise repos'
#        required: false
#      github_event_name:
#        type: string
#        description: 'Name of the github event (github.event_name), used to handle pull requests'
#        required: false
#        default: ${{ github.event_name }}
#      github_event_number:
#        type: string
#        description: 'Number of the github event (github.event_number), used to handle pull requests'
#        required: false
#      github_base_ref:
#        type: string
#        description: 'Base reference (github.base_ref) for testing the github pull request'
#        required: false
#        default: ${{ github.base_ref }}
#      github_sha:
#        type: string
#        required: false
#        description: 'github.sha is used in generating the cache id'
#        default: ${{ github.sha }}
#      github_run_number:
#        type: string
#        required: false
#        description: 'github.run_number and github.run_attempts are used in generating the cache id'
#      github_run_attempt:
#        type: string
#        required: false
#        description: 'github.run_number and github.run_attempts are used in generating the cache id'
#      php:
#        type: string
#        required: false
#        description: 'Version of PHP for this instance'
#        default: '["8.1","8.2"]'
#      mysql:
#        type: string
#        required: false
#        description: 'Version of MySQL for this instance'
#        default: '["5.7","8.0"]'
#      is_enterprise:
#        type: boolean
#        required: false
#        description: 'This action can be used on the community edition (ce) and enterprise edition (ee) of the shop. On top of setting this to true, a few extra variables/secrets must be provided for using the action on ee.'
#        default: false
#      enterprise_github_token:
#        type: string
#        required: false
#        description: 'OAuth token to access enterprise repos'
#        default: ''
    secrets:
      enterprise_github_token:
        description: 'OAuth token to access enterprise repos'
        required: false
      DOCKER_HUB_USER:
        description: 'user for the docker login'
        required: false
      DOCKER_HUB_TOKEN:
        description: 'Token for the docker login'
        required: false
      CACHE_ENDPOINT:
        description: 'Endpoint for tespkg/actions-cache@v1'
        required: false # only for ee
      CACHE_ACCESS_KEY:
        description: 'Access key for tespkg/actions-cache@v1'
        required: false # only for ee
      CACHE_SECRET_KEY:
        description: 'Secret key for tespkg/actions-cache@v1'
        required: false # only for ee
      enterprise_github_token:
        required: false
        description: 'OAuth token to access enterprise repos'
  
jobs:
  init:
    runs-on: ${{ fromJSON(env.workflow_runs_on) }}
    steps:
      - name: 'Load Testplan'
        uses: 'OXID-eSales/github-actions/load_testplan@v0'
        with:
          testplan: ${{ inputs.testplan }}
      - name: Login to Docker Hub
        if: ${{ env.init_docker_login == 'true' }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USER }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
          logout: false

  prepare_shop:
    strategy:
      matrix:
        php: ${{ fromJSON(env.workflow_matrix_php) }}
        mysql: ${{ fromJSON(env.workflow_matrix_mysql) }}
      fail-fast: false
    needs: init
    runs-on: ${{ fromJSON(env.workflow_runs_on) }}
    outputs:
      prepared_shop: ${{ steps.prepare_shop.outputs.prepared_shop }}
    steps:
      - name: 'Cleanup (pre)'
        if: ${{ env.prepare_shop_pre_cleanup }}
        uses: 'OXID-eSales/github-actions/cleanup_workspace@v0'

      - name: 'Prepare Shop'
        id: prepare_shop
        uses: 'OXID-eSales/github-actions/prepare_shop@v0'
        with:
          git_sdk_url: ${{ env.prepare_shop_git_sdk_url }}
          git_sdk_ref: ${{ env.prepare_shop_git_sdk_ref }}
          git_shop_url: ${{ env.prepare_shop_git_shop_url }}
          git_shop_ref: ${{ env.prepare_shop_git_shop_ref }}
          git_enterprise_ref: ${{ env.prepare_shop_git_enterprise_ref }}
          github_event_name: ${{ github.event_name }}
          github_event_number: ${{ github.event_number }}
          github_base_ref: ${{ github.base_ref }}
          github_sha: ${{ github.sha }}
          github_run_number: ${{ github.run_number }}
          github_run_attempt: ${{ github.run_attempt }}
          php: ${{ matrix.php }}
          mysql: ${{ matrix.mysql }}
          is_enterprise: ${{ env.prepare_shop_is_enterprise }}
          custom_ini_error_reporting: ${{ env.prepare_shop_custom_ini_error_reporting }}
          custom_ini_xdebug: ${{ env.prepare_shop_custom_ini_xdebug }}
          add_services: ${{ env.prepare_shop_add_services }}
          enterprise_github_token: ${{ secrets.enterprise_github_token }}
          cache_bucket: ${{ env.prepare_shop_cache_bucket }}
          cache_endpoint: ${{ secrets.CACHE_ENDPOINT }}
          cache_access_key: ${{ secrets.CACHE_ACCESS_KEY }}
          cache_secret_key: ${{ secrets.CACHE_SECRET_KEY }}

  install_shop:
    needs: [ prepare_shop ]
    strategy:
      matrix:
        php: ${{ fromJSON(env.workflow_matrix_php) }}
        mysql: ${{ fromJSON(env.workflow_matrix_mysql) }}
      fail-fast: false
    needs: init
    runs-on: ${{ fromJSON(env.workflow_runs_on) }}
    outputs:
      installed_shop: ${{ steps.install_shop.outputs.installed_shop }}
    steps:
      - name: 'Cleanup (pre)'
        if: ${{ env.install_shop_pre_cleanup }}
        uses: 'OXID-eSales/github-actions/cleanup_workspace@v0'

      - name: 'Start shop'
        uses: 'OXID-eSales/github-actions/start_shop@v0'
        with:
          cached_shop: ${{ needs.prepare_shop.outputs.prepared_shop }}
          cache_bucket: ${{ env.install_shop_cache_bucket }}
          cache_endpoint: ${{ secrets.CACHE_ENDPOINT }}
          cache_access_key: ${{ secrets.CACHE_ACCESS_KEY }}
          cache_secret_key: ${{ secrets.CACHE_SECRET_KEY }}        

      - name: 'Install shop'
        id: install_shop
        uses: 'OXID-eSales/github-actions/install_shop@v0'
        with:
          git_shop_ref: ${{ env.install_shop_git_shop_ref }}
          git_enterprise_ref: ${{ env.install_shop_git_enterprise_ref }}
          github_sha: ${{ github.sha }}
          github_run_number: ${{ github.run_number }}
          github_run_attempt: ${{ github.run_attempt }}
          php: ${{ matrix.php }}
          mysql: ${{ matrix.mysql }}
          is_enterprise: ${{ env.install_shop_is_enterprise }}
          config_idebug: ${{ env.install_shop_config_idebug }}
          cache_bucket: ${{ env.prepare_shop_cache_bucket }}
          cache_endpoint: ${{ secrets.CACHE_ENDPOINT }}
          cache_access_key: ${{ secrets.CACHE_ACCESS_KEY }}
          cache_secret_key: ${{ secrets.CACHE_SECRET_KEY }}

  unit_tests:
    strategy:
      matrix:
        php: ${{ fromJSON(inputs.php) }}
        mysql: ${{ fromJSON(inputs.mysql) }}
      fail-fast: false
    needs: [ install_shop ]
    runs-on: ${{ fromJSON(inputs.runs_on) }}
    steps:
      - name: 'Cleanup (pre)'
        uses: 'OXID-eSales/github-actions/cleanup_workspace@v0'

      - name: 'Start shop'
        uses: 'OXID-eSales/github-actions/start_shop@v0'
        with:
          cached_shop: ${{ needs.install_shop.outputs.installed_shop }}
          cache_endpoint: ${{ secrets.CACHE_ENDPOINT }}
          cache_access_key: ${{ secrets.CACHE_ACCESS_KEY }}
          cache_secret_key: ${{ secrets.CACHE_SECRET_KEY }}

      - name: 'Run unit tests (ce)'
        if: inputs.is_enterprise == false
        uses: 'OXID-eSales/github-actions/phpunit@v0'
        with:
          test: 'tests/Unit'
          logfile: unit_PHP${{ matrix.php }}_MYSQL${{ matrix.mysql }}_phpunit_log.txt

      - name: 'Run unit tests (ee)'
        if: inputs.is_enterprise == true
        uses: 'OXID-eSales/github-actions/phpunit@v0'
        with:
          test: 'vendor/oxid-esales/oxideshop-ee/Tests/Unit'
          logfile: 'unit_PHP${{ matrix.php }}_MYSQL${{ matrix.mysql }}_phpunit_log.txt'

  integration_tests:
    strategy:
      matrix:
        php: ${{ fromJSON(inputs.php) }}
        mysql: ${{ fromJSON(inputs.mysql) }}
      fail-fast: false
    needs: [ install_shop ]
    runs-on: ${{ fromJSON(inputs.runs_on) }}
    steps:
      - name: 'Cleanup (pre)'
        uses: 'OXID-eSales/github-actions/cleanup_workspace@v0'

      - name: 'Start shop'
        uses: 'OXID-eSales/github-actions/start_shop@v0'
        with:
          cached_shop: ${{ needs.install_shop.outputs.installed_shop }}
          cache_endpoint: ${{ secrets.CACHE_ENDPOINT }}
          cache_access_key: ${{ secrets.CACHE_ACCESS_KEY }}
          cache_secret_key: ${{ secrets.CACHE_SECRET_KEY }}

      - name: 'Run integration tests (ce)'
        if: inputs.is_enterprise == false
        uses: 'OXID-eSales/github-actions/phpunit@v0'
        with:
          test: 'tests/Integration'
          additional_options: '--bootstrap tests/bootstrap.php'
          logfile: integration_PHP${{ matrix.php }}_MYSQL${{ matrix.mysql }}_phpunit_log.txt

      - name: 'Run integration tests (ee)'
        if: inputs.is_enterprise == true
        uses: 'OXID-eSales/github-actions/phpunit@v0'
        with:
          test: 'vendor/oxid-esales/oxideshop-ee/Tests/Integration'
          additional_options: '--bootstrap tests/bootstrap.php'
          logfile: 'integration_PHP${{ matrix.php }}_MYSQL${{ matrix.mysql }}_phpunit_log.txt'
  
  codeception_tests:
    strategy:
      matrix:
        php: ${{ fromJSON(inputs.php) }}
        mysql: ${{ fromJSON(inputs.mysql) }}
      fail-fast: false
    needs: [ install_shop ]
    runs-on: ${{ fromJSON(inputs.runs_on) }}
    steps:
      - name: 'Cleanup (pre)'
        uses: 'OXID-eSales/github-actions/cleanup_workspace@v0'

      - name: 'Start shop'
        uses: 'OXID-eSales/github-actions/start_shop@v0'
        with:
          cached_shop: ${{ needs.install_shop.outputs.installed_shop }}
          cache_endpoint: ${{ secrets.CACHE_ENDPOINT }}
          cache_access_key: ${{ secrets.CACHE_ACCESS_KEY }}
          cache_secret_key: ${{ secrets.CACHE_SECRET_KEY }}        

      - name: Install admin theme and template engine and APEX theme
        uses: 'OXID-eSales/github-actions/install_themes@v0'
        with:
          themes: 'oxid-esales/twig-admin-theme:dev-b-8.0.x oxid-esales/apex-theme:dev-b-7.1.x'

      - name: 'Run codeception tests (ce)'
        if: inputs.is_enterprise == false
        uses: 'OXID-eSales/github-actions/codeception@v0'
        with:
          additional_options: '--skip-group flow_theme'
          logfile: codeception_PHP${{ matrix.php }}_MYSQL${{ matrix.mysql }}_phpunit_log.txt

      - name: 'Run codeception tests (ee)'
        if: inputs.is_enterprise == true
        uses: 'OXID-eSales/github-actions/codeception@v0'
        with:
          configuration: 'vendor/oxid-esales/oxideshop-ee/Tests/codeception.yml'
          build: true
          logfile: codeception_PHP${{ matrix.php }}_MYSQL${{ matrix.mysql }}_phpunit_log.txt
          output_folder: 'source/vendor/oxid-esales/oxideshop-ee/Tests/Codeception/_output'
 
  shop_setup_tests:
    strategy:
      matrix:
        php: ${{ fromJSON(inputs.php) }}
        mysql: ${{ fromJSON(inputs.mysql) }}
      fail-fast: false
    needs: [ prepare_shop ]
    runs-on: ${{ fromJSON(inputs.runs_on) }}
    steps:
      - name: 'Cleanup (pre)'
        uses: 'OXID-eSales/github-actions/cleanup_workspace@v0'

      - name: 'Start shop'
        uses: 'OXID-eSales/github-actions/start_shop@v0'
        with:
          cached_shop: ${{ needs.prepare_shop.outputs.prepared_shop }}
          cache_endpoint: ${{ secrets.CACHE_ENDPOINT }}
          cache_access_key: ${{ secrets.CACHE_ACCESS_KEY }}
          cache_secret_key: ${{ secrets.CACHE_SECRET_KEY }}        

      - name: Install admin theme and template engine and APEX theme
        if: inputs.is_enterprise == false
        uses: 'OXID-eSales/github-actions/install_themes@v0'
        with:
          themes: 'oxid-esales/twig-admin-theme oxid-esales/apex-theme'

      - name: 'Run codeception tests (ce)'
        if: inputs.is_enterprise == false
        uses: 'OXID-eSales/github-actions/codeception@v0'
        with:
          additional_options: '--skip-group flow_theme'
          logfile: codeception_PHP${{ matrix.php }}_MYSQL${{ matrix.mysql }}_phpunit_log.txt

      - name: 'Run codeception tests (ee)'
        if: inputs.is_enterprise == true
        uses: 'OXID-eSales/github-actions/codeception@v0'
        with:
          configuration: 'vendor/oxid-esales/oxideshop-ee/Tests/codeception.yml'
          build: true
          logfile: codeception_PHP${{ matrix.php }}_MYSQL${{ matrix.mysql }}_phpunit_log.txt
          output_folder: 'source/vendor/oxid-esales/oxideshop-ee/Tests/Codeception/_output'

      - name: 'Run shop setup tests (ce)'
        if: inputs.is_enterprise == false
        uses: 'OXID-eSales/github-actions/shop_setup_tests@v0'
        with:
          container_options: '-e SELENIUM_SERVER_HOST=selenium -e BROWSER_NAME=chrome -e DB_NAME=setup_test -e DB_USERNAME=root -e DB_PASSWORD=root -e DB_HOST=mysql -e DB_PORT=3306 -e SHOP_URL=http://localhost.local/ -e SHOP_SOURCE_PATH=/var/www/source/'
          suite: 'acceptanceSetup'
          additional_options: '--skip-group flow_theme'
          logfile: shop_setup_PHP${{ matrix.php }}_MYSQL${{ matrix.mysql }}_phpunit_log.txt
          output_artifact: shop_setup-artifacts
        
      - name: 'Run shop setup tests (ee)'
        if: inputs.is_enterprise == true
        uses: 'OXID-eSales/github-actions/shop_setup_tests@v0'
        with:
          container_options: '-e SELENIUM_SERVER_HOST=selenium -e BROWSER_NAME=chrome -e DB_NAME=setup_test -e DB_USERNAME=root -e DB_PASSWORD=root -e DB_HOST=mysql -e DB_PORT=3306 -e SHOP_URL=http://localhost.local/ -e SHOP_SOURCE_PATH=/var/www/source/'
          configuration: 'vendor/oxid-esales/oxideshop-ee/Tests/codeception.yml'
          build: true
          suite: 'acceptanceSetup'
          logfile: shop_setup_PHP${{ matrix.php }}_MYSQL${{ matrix.mysql }}_phpunit_log.txt
          output_folder: 'source/vendor/oxid-esales/oxideshop-ee/Tests/Codeception/_output'
          output_artifact: shop_setup-artifacts

  finish:
    if: ${{ always() }}
    strategy:
      matrix:
        php: ${{ fromJSON(inputs.php) }}
        mysql: ${{ fromJSON(inputs.mysql) }}
      fail-fast: false
    needs:
      - prepare_shop
      - install_shop
      - unit_tests
      - integration_tests
      - codeception_tests
      - shop_setup_tests
    runs-on: ${{ fromJSON(inputs.runs_on) }}
    steps:
      - name: 'Cleanup (post)'
        uses: 'OXID-eSales/github-actions/cleanup_workspace@v0'

      - name: 'Docker logout'
        shell: bash
        run: |
          docker logout
          